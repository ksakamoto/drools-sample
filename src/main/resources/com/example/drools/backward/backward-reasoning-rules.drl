package com.example.drools.backward

import com.example.drools.Customer
import com.example.drools.CustomerRank
import com.example.drools.RankRequirement

global Boolean analysisCompleted;

rule "Initialize Current Rank Analysis"
no-loop
when
    $customer: Customer($name: name, $rank: currentRank)
    not RankRequirement(customerName == $name)
then
    CustomerRank nextRank = $rank.getNextRank();
    if (nextRank != null) {
        RankRequirement requirement = new RankRequirement($name, $rank, nextRank);
        requirement.setAnalysisRequested(true);
        insert(requirement);
        System.out.println("=== Backward Reasoning Analysis for " + $name + " ===");
        System.out.println("Current Status: " + $customer.toString());
        System.out.println("Analyzing requirements to upgrade from " + $rank.getDisplayName() + " to " + nextRank.getDisplayName());
    }
end

rule "Analyze Requirements"
no-loop
when
    $customer: Customer($name: name, $purchases: purchaseCount, $spent: totalSpent, $points: loyaltyPoints)
    $requirement: RankRequirement(customerName == $name, $targetRank: targetRank, analysisRequested == true, analysisCompleted == false)
then
    // Check purchase count
    int requiredPurchases = $targetRank.getMinPurchaseCount();
    if ($purchases < requiredPurchases) {
        int shortfall = requiredPurchases - $purchases;
        $requirement.addMissingRequirement("è¿½åŠ è³¼å…¥å›æ•°: " + shortfall + "å› (ç¾åœ¨: " + $purchases + "å›, å¿…è¦: " + requiredPurchases + "å›)");
    }
    
    // Check total spent
    double requiredSpent = $targetRank.getMinTotalSpent();
    if ($spent < requiredSpent) {
        double shortfall = requiredSpent - $spent;
        $requirement.addMissingRequirement("è¿½åŠ è³¼å…¥é‡‘é¡: Â¥" + String.format("%.0f", shortfall) + " (ç¾åœ¨: Â¥" + String.format("%.0f", $spent) + ", å¿…è¦: Â¥" + String.format("%.0f", requiredSpent) + ")");
    }
    
    // Check loyalty points
    int requiredPoints = $targetRank.getMinLoyaltyPoints();
    if ($points < requiredPoints) {
        int shortfall = requiredPoints - $points;
        $requirement.addMissingRequirement("è¿½åŠ ãƒ­ã‚¤ãƒ¤ãƒ«ãƒ†ã‚£ãƒã‚¤ãƒ³ãƒˆ: " + shortfall + "pt (ç¾åœ¨: " + $points + "pt, å¿…è¦: " + requiredPoints + "pt)");
    }

    // Complete analysis
    $requirement.setAnalysisCompleted(true);
    
    System.out.println("\n--- " + $targetRank.getDisplayName() + "ãƒ©ãƒ³ã‚¯ã«ãªã‚‹ãŸã‚ã®ä¸è¶³è¦ä»¶ ---");
    
    if ($requirement.getMissingRequirements().isEmpty()) {
        System.out.println("âœ… ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼" + $targetRank.getDisplayName() + "ãƒ©ãƒ³ã‚¯ã®æ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã™ï¼");
    } else {
        System.out.println("âŒ " + $targetRank.getDisplayName() + "ãƒ©ãƒ³ã‚¯ã«ãªã‚‹ãŸã‚ã«ã¯ä»¥ä¸‹ãŒä¸è¶³ã—ã¦ã„ã¾ã™:");
        for (String req : $requirement.getMissingRequirements()) {
            System.out.println("  â€¢ " + req);
        }
        
        System.out.println("\nğŸ’¡ ææ¡ˆã•ã‚Œã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:");
        if ($requirement.getMissingRequirements().stream().anyMatch(r -> r.contains("è¿½åŠ è³¼å…¥å›æ•°"))) {
            System.out.println("  ğŸ“¦ ã‚ˆã‚Šé »ç¹ã«ãŠè²·ã„ç‰©ã‚’ã—ã¦ãã ã•ã„");
        }
        if ($requirement.getMissingRequirements().stream().anyMatch(r -> r.contains("è¿½åŠ è³¼å…¥é‡‘é¡"))) {
            System.out.println("  ğŸ’° é«˜å˜ä¾¡å•†å“ã®è³¼å…¥ã‚’æ¤œè¨ã—ã¦ãã ã•ã„");
        }
        if ($requirement.getMissingRequirements().stream().anyMatch(r -> r.contains("ãƒ­ã‚¤ãƒ¤ãƒ«ãƒ†ã‚£ãƒã‚¤ãƒ³ãƒˆ"))) {
            System.out.println("  ğŸ¯ ãƒã‚¤ãƒ³ãƒˆç²å¾—ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã«å‚åŠ ã—ã¦ãã ã•ã„");
        }
    }
    System.out.println("=====================================\n");
    
    update($requirement);
end